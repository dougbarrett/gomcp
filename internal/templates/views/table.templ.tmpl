package views

import (
	"[[.ModulePath]]/internal/models"
	"[[.ModulePath]]/internal/web/components"
	"github.com/templui/templui/components/button"
	"github.com/templui/templui/components/icon"
	"github.com/templui/templui/components/table"
	"github.com/templui/templui/components/badge"
	"github.com/templui/templui/components/checkbox"
)

// [[.ModelName]]TableProps contains props for the [[.ModelName]] table view.
type [[.ModelName]]TableProps struct {
	Items       []models.[[.ModelName]]
	Page        int
	TotalPages  int
	TotalItems  int
	SortBy      string
	SortDir     string
	[[- if .WithSearch]]
	SearchQuery string
	[[- end]]
	[[- if .WithBulkActions]]
	SelectedIDs []uint
	[[- end]]
}

// [[.ModelName]]Table renders a data table for [[pluralize .ModelName]].
templ [[.ModelName]]Table(props [[.ModelName]]TableProps) {
	<div class="space-y-4">
		<!-- Header -->
		<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
			<div>
				<h1 class="text-2xl font-bold text-gray-900 dark:text-white">[[pluralize .ModelName]]</h1>
				<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
					{ fmt.Sprintf("%d total", props.TotalItems) }
				</p>
			</div>
			<div class="flex items-center gap-3">
				[[- if .WithSearch]]
				<div class="relative">
					<input
						type="search"
						name="q"
						value={ props.SearchQuery }
						placeholder="Search..."
						class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-800 dark:border-gray-600"
						hx-get="[[.URLPath]]"
						hx-trigger="input changed delay:300ms, search"
						hx-target="#[[.VariableName]]-table-container"
						hx-push-url="true"
					/>
					@icon.Icon(icon.Props{Name: "search", Class: "absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"})
				</div>
				[[- end]]
				@button.Button(button.Props{
					Variant: "default",
					Attributes: templ.Attributes{
						"hx-get":    "[[.URLPath]]/new",
						"hx-target": "#modal-container",
						"hx-swap":   "innerHTML",
					},
				}) {
					@icon.Icon(icon.Props{Name: "plus", Class: "h-4 w-4 mr-2"})
					Add [[.ModelName]]
				}
			</div>
		</div>

		[[- if .WithBulkActions]]
		<!-- Bulk Actions (shown when items selected) -->
		<div id="bulk-actions" class="hidden bg-gray-50 dark:bg-gray-800 p-4 rounded-lg flex items-center gap-4">
			<span class="text-sm text-gray-600 dark:text-gray-400">
				<span id="selected-count">0</span> items selected
			</span>
			@button.Button(button.Props{
				Variant: "destructive",
				Size:    "sm",
				Attributes: templ.Attributes{
					"hx-delete":  "[[.URLPath]]/bulk",
					"hx-confirm": "Are you sure you want to delete the selected items?",
					"hx-target":  "#[[.VariableName]]-table-container",
					"hx-include": "[name='ids']",
				},
			}) {
				Delete Selected
			}
		</div>
		[[- end]]

		<!-- Table Container -->
		<div id="[[.VariableName]]-table-container" class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
			if len(props.Items) == 0 {
				@[[.ModelName]]TableEmpty()
			} else {
				@table.Table(table.Props{}) {
					@table.Header(table.HeaderProps{}) {
						@table.Row(table.RowProps{}) {
							[[- if .WithBulkActions]]
							@table.Head(table.HeadProps{Class: "w-12"}) {
								@checkbox.Checkbox(checkbox.Props{
									ID: "select-all",
									Attributes: templ.Attributes{
										"_": "on change set checked of <input[name='ids']/> to my.checked then call updateBulkUI()",
									},
								})
							}
							[[- end]]
							[[- range .Columns]]
							@table.Head(table.HeadProps{
								[[- if .Sortable]]
								Class: "cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800",
								[[- end]]
							}) {
								[[- if .Sortable]]
								<div
									class="flex items-center gap-1"
									hx-get={ fmt.Sprintf("[[$.URLPath]]?sort=[[.Key]]&dir=%s", toggleSortDir(props.SortBy, "[[.Key]]", props.SortDir)) }
									hx-target="#[[$.VariableName]]-table-container"
									hx-push-url="true"
								>
									[[.Label]]
									if props.SortBy == "[[.Key]]" {
										if props.SortDir == "asc" {
											@icon.Icon(icon.Props{Name: "chevron-up", Class: "h-4 w-4"})
										} else {
											@icon.Icon(icon.Props{Name: "chevron-down", Class: "h-4 w-4"})
										}
									}
								</div>
								[[- else]]
								[[.Label]]
								[[- end]]
							}
							[[- end]]
							@table.Head(table.HeadProps{Class: "w-24 text-right"}) {
								Actions
							}
						}
					}
					@table.Body(table.BodyProps{}) {
						for _, item := range props.Items {
							@[[.ModelName]]TableRow(item)
						}
					}
				}
				[[- if .WithPagination]]
				if props.TotalPages > 1 {
					<div class="border-t border-gray-200 dark:border-gray-700 px-4 py-3">
						@components.Pagination(components.PaginationProps{
							CurrentPage: props.Page,
							TotalPages:  props.TotalPages,
							BaseURL:     "[[.URLPath]]",
						})
					</div>
				}
				[[- end]]
			}
		</div>
	</div>

	<!-- Modal Container -->
	<div id="modal-container"></div>

	[[- if .WithBulkActions]]
	<script>
		function updateBulkUI() {
			const checkboxes = document.querySelectorAll('input[name="ids"]:checked');
			const bulkActions = document.getElementById('bulk-actions');
			const selectedCount = document.getElementById('selected-count');

			if (checkboxes.length > 0) {
				bulkActions.classList.remove('hidden');
				selectedCount.textContent = checkboxes.length;
			} else {
				bulkActions.classList.add('hidden');
			}
		}
	</script>
	[[- end]]
}

// [[.ModelName]]TableRow renders a single table row.
templ [[.ModelName]]TableRow(item models.[[.ModelName]]) {
	@table.Row(table.RowProps{
		Class: "hover:bg-gray-50 dark:hover:bg-gray-800",
	}) {
		[[- if .WithBulkActions]]
		@table.Cell(table.CellProps{}) {
			@checkbox.Checkbox(checkbox.Props{
				Name:  "ids",
				Value: fmt.Sprintf("%d", item.ID),
				Attributes: templ.Attributes{
					"_": "on change call updateBulkUI()",
				},
			})
		}
		[[- end]]
		[[- range .Columns]]
		@table.Cell(table.CellProps{}) {
			[[- if eq .Format "badge"]]
			@badge.Badge(badge.Props{}) {
				{ [[if eq (goType .Key) "string"]]item.[[toPascalCase .Key]][[else]]fmt.Sprintf("%v", item.[[toPascalCase .Key]])[[end]] }
			}
			[[- else if eq .Format "date"]]
			{ item.[[toPascalCase .Key]].Format("Jan 02, 2006") }
			[[- else if eq .Format "datetime"]]
			{ item.[[toPascalCase .Key]].Format("Jan 02, 2006 3:04 PM") }
			[[- else if eq .Format "currency"]]
			{ fmt.Sprintf("$%.2f", item.[[toPascalCase .Key]]) }
			[[- else if eq .Format "bool"]]
			if item.[[toPascalCase .Key]] {
				@badge.Badge(badge.Props{Variant: "success"}) { Yes }
			} else {
				@badge.Badge(badge.Props{Variant: "secondary"}) { No }
			}
			[[- else]]
			{ [[if eq (goType .Key) "string"]]item.[[toPascalCase .Key]][[else]]fmt.Sprintf("%v", item.[[toPascalCase .Key]])[[end]] }
			[[- end]]
		}
		[[- end]]
		@table.Cell(table.CellProps{Class: "text-right"}) {
			<div class="flex items-center justify-end gap-1">
				[[- range .RowActions]]
				[[- if eq .Type "view"]]
				@button.Button(button.Props{
					Variant: "ghost",
					Size:    "sm",
					Attributes: templ.Attributes{
						"hx-get":      fmt.Sprintf("[[$.URLPath]]/%d", item.ID),
						"hx-target":   "#main-content",
						"hx-push-url": "true",
					},
				}) {
					@icon.Icon(icon.Props{Name: "eye", Class: "h-4 w-4"})
				}
				[[- else if eq .Type "edit"]]
				@button.Button(button.Props{
					Variant: "ghost",
					Size:    "sm",
					Attributes: templ.Attributes{
						"hx-get":    fmt.Sprintf("[[$.URLPath]]/%d/edit", item.ID),
						"hx-target": "#modal-container",
						"hx-swap":   "innerHTML",
					},
				}) {
					@icon.Icon(icon.Props{Name: "pencil", Class: "h-4 w-4"})
				}
				[[- else if eq .Type "delete"]]
				@button.Button(button.Props{
					Variant: "ghost",
					Size:    "sm",
					Attributes: templ.Attributes{
						"hx-delete":  fmt.Sprintf("[[$.URLPath]]/%d", item.ID),
						[[- if .Confirm]]
						"hx-confirm": "[[.ConfirmMessage]]",
						[[- end]]
						"hx-target":  "closest tr",
						"hx-swap":    "outerHTML swap:300ms",
					},
				}) {
					@icon.Icon(icon.Props{Name: "trash", Class: "h-4 w-4 text-red-500"})
				}
				[[- end]]
				[[- end]]
			</div>
		}
	}
}

// [[.ModelName]]TableEmpty renders the empty state.
templ [[.ModelName]]TableEmpty() {
	<div class="text-center py-12">
		<div class="mx-auto h-12 w-12 text-gray-400">
			@icon.Icon(icon.Props{Name: "inbox", Class: "h-12 w-12"})
		</div>
		<h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">No [[pluralize .ModelName | toLower]] found</h3>
		<p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
			Get started by creating a new [[.ModelName | toLower]].
		</p>
		<div class="mt-6">
			@button.Button(button.Props{
				Variant: "default",
				Attributes: templ.Attributes{
					"hx-get":    "[[.URLPath]]/new",
					"hx-target": "#modal-container",
					"hx-swap":   "innerHTML",
				},
			}) {
				@icon.Icon(icon.Props{Name: "plus", Class: "h-4 w-4 mr-2"})
				Add [[.ModelName]]
			}
		</div>
	</div>
}

// toggleSortDir returns the next sort direction.
func toggleSortDir(currentSortBy, column, currentDir string) string {
	if currentSortBy != column {
		return "asc"
	}
	if currentDir == "asc" {
		return "desc"
	}
	return "asc"
}
