package views

import (
	"fmt"

	"[[.WizardData.ModulePath]]/internal/web/components"
)

// [[.WizardData.WizardNamePascal]]Step[[.Step.Number]]Props contains props for step [[.Step.Number]].
type [[.WizardData.WizardNamePascal]]Step[[.Step.Number]]Props struct {
	CurrentStep int
	TotalSteps  int
	CSRFToken   string
	Errors      map[string]string
	[[- if .WizardData.WithDrafts]]
	DraftID     string
	StepData    map[string]interface{}
	[[- end]]
	// SummaryItems contains the collected data to review.
	SummaryItems []components.SummaryItem
}

// [[.WizardData.WizardNamePascal]]Step[[.Step.Number]] renders the summary step [[.Step.Number]]: [[.Step.Name]].
templ [[.WizardData.WizardNamePascal]]Step[[.Step.Number]](props [[.WizardData.WizardNamePascal]]Step[[.Step.Number]]Props) {
	@[[.WizardData.WizardNamePascal]]WizardLayout([[.WizardData.WizardNamePascal]]WizardProps{
		CurrentStep: props.CurrentStep,
		TotalSteps:  props.TotalSteps,
		CSRFToken:   props.CSRFToken,
		[[- if .WizardData.WithDrafts]]
		DraftID:     props.DraftID,
		[[- end]]
	}) {
		<div class="space-y-6">
			<div>
				<h2 class="text-xl font-semibold text-gray-900 dark:text-white">
					[[.Step.Name]]
				</h2>
				<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
					Review your selections below before submitting.
				</p>
			</div>

			<!-- Summary Display -->
			@components.Card(components.CardProps{}) {
				@components.CardContent("") {
					if len(props.SummaryItems) == 0 {
						[[- if .WizardData.WithDrafts]]
						// Build summary from step data
						if props.StepData != nil {
							@components.WizardSummary(buildSummaryFromStepData(props.StepData[[if .WizardData.WithDrafts]], props.DraftID[[end]]))
						} else {
							<p class="text-sm text-gray-500 dark:text-gray-400">
								No data to display. Please complete the previous steps.
							</p>
						}
						[[- else]]
						<p class="text-sm text-gray-500 dark:text-gray-400">
							No data to display. Please complete the previous steps.
						</p>
						[[- end]]
					} else {
						@components.WizardSummary(props.SummaryItems)
					}
				}
			}

			[[- if .Step.FieldNames]]
			<!-- Additional Fields for Summary Step -->
			<div class="space-y-4">
				<h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Additional Information</h3>
				[[- range .Step.FieldNames]]
				<div class="space-y-2">
					@components.Label("[[.]]", false) {
						[[. | toLabel]]
					}
					@components.Input(components.InputProps{
						ID:          "[[.]]",
						Name:        "[[.]]",
						Type:        "text",
						Placeholder: "Enter [[. | toLabel | toLower]] (optional)",
						[[- if $.WizardData.WithDrafts]]
						Value:       func() string { if props.StepData != nil { if v, ok := props.StepData["[[.]]"].(string); ok { return v } }; return "" }(),
						[[- end]]
						Error:       props.Errors["[[.]]"],
					})
					@components.FormError(props.Errors["[[.]]"])
				</div>
				[[- end]]
			</div>
			[[- end]]

			<!-- Submit Form -->
			<form
				method="POST"
				action={ templ.SafeURL(fmt.Sprintf("[[.WizardData.URLPath]]/wizard/[[.WizardData.WizardName]]/submit")) }
				hx-post={ fmt.Sprintf("[[.WizardData.URLPath]]/wizard/[[.WizardData.WizardName]]/submit") }
				hx-target="#main-content"
				hx-swap="innerHTML"
				class="space-y-4"
			>
				<input type="hidden" name="csrf_token" value={ props.CSRFToken }/>
				[[- if .WizardData.WithDrafts]]
				<input type="hidden" name="draft_id" value={ props.DraftID }/>
				[[- end]]

				@components.FormError(props.Errors["submit"])

				@components.WizardNav(components.WizardNavProps{
					[[- if not .Step.IsFirst]]
					ShowPrev:   true,
					[[- if .WizardData.WithDrafts]]
					PrevURL:    fmt.Sprintf("[[.WizardData.URLPath]]/wizard/[[.WizardData.WizardName]]/step/[[sub .Step.Number 1]]?draft_id=%s", props.DraftID),
					[[- else]]
					PrevURL:    "[[.WizardData.URLPath]]/wizard/[[.WizardData.WizardName]]/step/[[sub .Step.Number 1]]",
					[[- end]]
					[[- end]]
					ShowSubmit:  true,
					SubmitLabel: "Create [[.WizardData.ModelName]]",
				})
			</form>
		</div>
	}
}

[[- if .WizardData.WithDrafts]]
// buildSummaryFromStepData converts step data to summary items.
func buildSummaryFromStepData(stepData map[string]interface{}[[if .WizardData.WithDrafts]], draftID string[[end]]) []components.SummaryItem {
	var items []components.SummaryItem

	// Convert each step data field to a summary item
	// TODO: Customize this based on your wizard's fields
	for key, value := range stepData {
		if strValue, ok := value.(string); ok && strValue != "" {
			items = append(items, components.SummaryItem{
				Label:   key,
				Value:   strValue,
				[[- if .WizardData.WithDrafts]]
				EditURL: fmt.Sprintf("[[.WizardData.URLPath]]/wizard/[[.WizardData.WizardName]]/step/1?draft_id=%s", draftID),
				[[- end]]
			})
		}
	}

	return items
}
[[- end]]
