package views

import (
	"fmt"

	"[[.ModulePath]]/internal/models"
	"[[.ModulePath]]/internal/web/components"
)

// ShowProps contains props for the user detail page.
type ShowProps struct {
	User          *models.User
	CurrentUserID uint
	CSRFToken     string
}

// ShowPage renders the full user detail page.
templ ShowPage(props ShowProps) {
	<div class="max-w-2xl mx-auto space-y-6">
		@components.PageHeader("User Details", "View user information")
		@UserDetail(props)
		<div class="mt-6">
			<a href="/admin/users" class="text-sm text-gray-600 hover:underline">
				&larr; Back to users
			</a>
		</div>
	</div>
}

// UserDetail renders the user detail card.
templ UserDetail(props ShowProps) {
	@components.Card(components.CardProps{}) {
		@components.CardHeader("") {
			<div class="flex items-center justify-between">
				<div class="flex items-center gap-4">
					<div class="h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center">
						<span class="text-2xl font-bold text-primary">
							{ string([]rune(props.User.Name)[0:1]) }
						</span>
					</div>
					<div>
						<h2 class="text-xl font-bold">{ props.User.Name }</h2>
						<p class="text-muted-foreground">{ props.User.Email }</p>
					</div>
				</div>
				<div class="flex items-center gap-2">
					<a
						href={ templ.SafeURL(fmt.Sprintf("/admin/users/%d/edit", props.User.ID)) }
						class="inline-flex items-center gap-2 px-3 py-2 border rounded-md hover:bg-muted"
					>
						@components.Icon("pencil", "h-4 w-4")
						Edit
					</a>
					if props.User.ID != props.CurrentUserID {
						<form
							method="POST"
							action={ templ.SafeURL(fmt.Sprintf("/admin/users/%d", props.User.ID)) }
							onsubmit="return confirm('Are you sure you want to delete this user?');"
						>
							<input type="hidden" name="csrf_token" value={ props.CSRFToken }/>
							<input type="hidden" name="_method" value="DELETE"/>
							<button
								type="submit"
								class="inline-flex items-center gap-2 px-3 py-2 border border-red-200 text-red-600 rounded-md hover:bg-red-50 dark:border-red-800 dark:hover:bg-red-900/20"
							>
								@components.Icon("trash", "h-4 w-4")
								Delete
							</button>
						</form>
					}
				</div>
			</div>
		}
		@components.CardContent("") {
			<div class="grid gap-6">
				<div class="grid grid-cols-2 gap-4">
					@detailItem("Status", "") {
						if props.User.Active {
							<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
								Active
							</span>
						} else {
							<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
								Inactive
							</span>
						}
					}
					@detailItem("Role", "") {
						if props.User.Role != nil {
							if props.User.Role.Name == "admin" {
								<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">
									{ props.User.Role.Name }
								</span>
							} else {
								<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200">
									{ props.User.Role.Name }
								</span>
							}
						} else {
							<span class="text-muted-foreground">-</span>
						}
					}
				</div>

				<div class="border-t pt-4">
					<h4 class="text-sm font-medium text-muted-foreground mb-3">Account Details</h4>
					<div class="grid grid-cols-2 gap-4">
						@detailItem("Created", props.User.CreatedAt.Format("January 2, 2006 at 3:04 PM")) {
						}
						@detailItem("Last Updated", props.User.UpdatedAt.Format("January 2, 2006 at 3:04 PM")) {
						}
						@detailItem("Last Login", "") {
							if props.User.LastLoginAt != nil {
								{ props.User.LastLoginAt.Format("January 2, 2006 at 3:04 PM") }
							} else {
								<span class="text-muted-foreground">Never</span>
							}
						}
						@detailItem("User ID", fmt.Sprintf("%d", props.User.ID)) {
						}
					</div>
				</div>

				if props.User.ID != props.CurrentUserID {
					<div class="border-t pt-4">
						<h4 class="text-sm font-medium text-muted-foreground mb-3">Quick Actions</h4>
						<div class="flex gap-2">
							<form method="POST" action={ templ.SafeURL(fmt.Sprintf("/admin/users/%d/toggle-active", props.User.ID)) }>
								<input type="hidden" name="csrf_token" value={ props.CSRFToken }/>
								if props.User.Active {
									<button
										type="submit"
										class="inline-flex items-center gap-2 px-3 py-2 border border-yellow-200 text-yellow-700 rounded-md hover:bg-yellow-50 dark:border-yellow-800 dark:text-yellow-400 dark:hover:bg-yellow-900/20"
									>
										@components.Icon("pause", "h-4 w-4")
										Deactivate User
									</button>
								} else {
									<button
										type="submit"
										class="inline-flex items-center gap-2 px-3 py-2 border border-green-200 text-green-700 rounded-md hover:bg-green-50 dark:border-green-800 dark:text-green-400 dark:hover:bg-green-900/20"
									>
										@components.Icon("play", "h-4 w-4")
										Activate User
									</button>
								}
							</form>
						</div>
					</div>
				} else {
					<div class="border-t pt-4">
						<div class="flex items-center gap-2 text-sm text-muted-foreground">
							@components.Icon("information-circle", "h-5 w-5")
							This is your account. Some actions are restricted.
						</div>
					</div>
				}
			</div>
		}
	}
}

// detailItem renders a detail item.
templ detailItem(label, value string) {
	<div>
		<dt class="text-sm font-medium text-muted-foreground">{ label }</dt>
		<dd class="mt-1 text-sm">
			if value != "" {
				{ value }
			} else {
				{ children... }
			}
		</dd>
	</div>
}
