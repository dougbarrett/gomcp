package config

import (
	"log"
	"os"
	"path/filepath"
	"sync"

	"github.com/BurntSushi/toml"
)

var sessionSecretWarningOnce sync.Once

// Config holds the application configuration.
type Config struct {
	Server   ServerConfig   `toml:"server"`
	Database DatabaseConfig `toml:"database"`
	Session  SessionConfig  `toml:"session"`
}

// ServerConfig holds server-related configuration.
type ServerConfig struct {
	Address string `toml:"address"`
	Debug   bool   `toml:"debug"`
}

// SessionConfig holds session-related configuration.
type SessionConfig struct {
	Secret   string `toml:"secret"`
	MaxAge   int    `toml:"max_age"`   // in seconds
	Secure   bool   `toml:"secure"`    // HTTPS only
	HttpOnly bool   `toml:"http_only"`
}

// DatabaseConfig holds database-related configuration.
type DatabaseConfig struct {
	Driver string `toml:"driver"`
	DSN    string `toml:"dsn"`
}

// Load loads the configuration from environment or defaults.
func Load() *Config {
	cfg := &Config{
		Server: ServerConfig{
			Address: getEnv("SERVER_ADDRESS", ":8080"),
			Debug:   getEnv("DEBUG", "false") == "true",
		},
		Database: DatabaseConfig{
			Driver: getEnv("DB_DRIVER", "[[.DatabaseType]]"),
			DSN:    getEnv("DB_DSN", getDefaultDSN()),
		},
		Session: SessionConfig{
			Secret:   getEnv("SESSION_SECRET", getDefaultSessionSecret()),
			MaxAge:   86400 * 7, // 7 days
			Secure:   getEnv("SESSION_SECURE", "false") == "true",
			HttpOnly: true,
		},
	}

	// Try to load from config file if it exists
	configPath := getEnv("CONFIG_PATH", "config/en/app.toml")
	if _, err := os.Stat(configPath); err == nil {
		if _, err := toml.DecodeFile(configPath, cfg); err != nil {
			log.Printf("Warning: failed to load config file: %v", err)
		}
	}

	return cfg
}

// LoadPageConfig loads page-specific configuration from TOML.
func LoadPageConfig(locale, pageName string) (map[string]interface{}, error) {
	path := filepath.Join("config", locale, "pages", pageName+".toml")
	var config map[string]interface{}
	if _, err := toml.DecodeFile(path, &config); err != nil {
		return nil, err
	}
	return config, nil
}

// LoadMenuConfig loads the menu configuration.
func LoadMenuConfig(locale string) (map[string]interface{}, error) {
	path := filepath.Join("config", locale, "menu.toml")
	var config map[string]interface{}
	if _, err := toml.DecodeFile(path, &config); err != nil {
		return nil, err
	}
	return config, nil
}

func getEnv(key, defaultValue string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return defaultValue
}

func getDefaultDSN() string {
[[- if eq .DatabaseType "sqlite"]]
	return "data.db"
[[- else if eq .DatabaseType "postgres"]]
	return "host=localhost user=postgres password=postgres dbname=[[.ProjectName]] port=5432 sslmode=disable"
[[- else if eq .DatabaseType "mysql"]]
	return "root:password@tcp(127.0.0.1:3306)/[[.ProjectName]]?charset=utf8mb4&parseTime=True&loc=Local"
[[- else]]
	return "data.db"
[[- end]]
}

func getDefaultSessionSecret() string {
	// WARNING: This default is for development only.
	// In production, always set SESSION_SECRET environment variable.
	sessionSecretWarningOnce.Do(func() {
		log.Println("WARNING: Using default session secret. Set SESSION_SECRET environment variable in production.")
	})
	return "[[.ProjectName]]-dev-secret-change-me-in-production"
}
