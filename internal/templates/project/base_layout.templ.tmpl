package layouts

import "context"
import "[[.ModulePath]]/internal/web/components"
import "[[.ModulePath]]/internal/web/middleware"

templ Base(title string) {
	<!DOCTYPE html>
	<html lang="en" class="h-full">
		<head>
			<meta charset="UTF-8"/>
			<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
			<title>{ title } - [[.ProjectName]]</title>
			<script src="https://unpkg.com/htmx.org@2.0.0"></script>
			<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
			// Tailwind CDN for development (remove in production and use compiled CSS only)
			<script src="https://cdn.tailwindcss.com"></script>
			// Compiled CSS (production)
			<link href="/assets/css/output.css" rel="stylesheet"/>
		</head>
		// Removed hx-boost="true" to avoid layout issues when navigating between pages
		// Add hx-boost selectively to specific elements if needed
		// hx-headers ensures CSRF token is included in all HTMX requests
		<body class="h-full bg-background text-foreground" hx-headers={ csrfHeader(ctx) }>
			<div id="app" class="min-h-full">
				{ children... }
			</div>
			<!-- Flash messages from session -->
			@components.FlashMessages(flashDataFromContext(ctx))
			<!-- Toast container for HTMX-triggered toasts -->
			<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
			<!-- Modal container -->
			<div id="modal-container"></div>
			<script>
				// Toast notification handler
				document.body.addEventListener('showToast', function(evt) {
					const toast = document.createElement('div');
					const type = evt.detail.type || 'info';
					const colors = {
						success: 'bg-green-500',
						error: 'bg-red-500',
						warning: 'bg-yellow-500',
						info: 'bg-blue-500'
					};
					toast.className = `${colors[type]} text-white px-4 py-2 rounded shadow-lg`;
					toast.textContent = evt.detail.message;
					document.getElementById('toast-container').appendChild(toast);
					setTimeout(() => toast.remove(), 3000);
				});
			</script>
		</body>
	</html>
}

// Dashboard renders a dashboard layout with children (for use in templ files).
// For composing from Go code, use DashboardPage instead.
templ Dashboard(title string) {
	@Base(title) {
		<div class="flex h-full">
			<!-- Sidebar -->
			<aside class="w-64 bg-card border-r hidden md:block">
				<div class="p-4 border-b">
					<h1 class="text-xl font-bold">[[.ProjectName]]</h1>
				</div>
				@SidebarNav()
			</aside>
			<!-- Main content -->
			<main class="flex-1 overflow-auto">
				<div id="main-content" class="p-6">
					{ children... }
				</div>
			</main>
		</div>
	}
}

// SidebarNav renders the sidebar navigation.
// Add your navigation items here or load from config.
templ SidebarNav() {
	<nav class="p-4 space-y-1">
		@navItem("/dashboard", "home", "Dashboard", true)
		// MCP:NAV_ITEMS:START
		// Add more navigation items here after scaffolding domains
		// MCP:NAV_ITEMS:END
		<div class="border-t my-4"></div>
		@navItem("/profile", "user", "Profile", false)
		@navItem("/settings", "cog", "Settings", false)
		<form method="POST" action="/logout" class="m-0">
			<button type="submit" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm text-red-600 hover:bg-red-50 transition-colors w-full text-left">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
					<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
				</svg>
				Logout
			</button>
		</form>
	</nav>
}

// navItem renders a single navigation item.
templ navItem(href, icon, label string, active bool) {
	<a
		href={ templ.SafeURL(href) }
		class={ "flex items-center gap-3 px-3 py-2 rounded-md text-sm transition-colors",
			templ.KV("bg-primary text-primary-foreground", active),
			templ.KV("hover:bg-muted", !active) }
	>
		@navIcon(icon)
		{ label }
	</a>
}

// navIcon renders an icon by name.
templ navIcon(name string) {
	switch name {
		case "home":
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/>
			</svg>
		case "user":
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
			</svg>
		case "cog":
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/>
				<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
			</svg>
		default:
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/>
			</svg>
	}
}

// DashboardPage renders a dashboard layout with content passed as a component.
// This is designed for easy composition from Go controller code.
//
// Example usage in a controller:
//
//	res.RenderWithLayout(
//	    func(c templ.Component) templ.Component {
//	        return layouts.DashboardPage("Users", c)
//	    },
//	    views.UserList(props),
//	)
//
// Or using the simpler pattern:
//
//	res.Render(layouts.DashboardPage("Users", views.UserList(props)))
templ DashboardPage(title string, content templ.Component) {
	@Base(title) {
		<div class="flex h-full">
			<!-- Sidebar -->
			<aside class="w-64 bg-card border-r hidden md:block">
				<div class="p-4 border-b">
					<h1 class="text-xl font-bold">[[.ProjectName]]</h1>
				</div>
				@SidebarNav()
			</aside>
			<!-- Main content -->
			<main class="flex-1 overflow-auto">
				<div id="main-content" class="p-6">
					@content
				</div>
			</main>
		</div>
	}
}

// BasePage renders a base layout with content passed as a component.
// Similar to DashboardPage but without the sidebar.
templ BasePage(title string, content templ.Component) {
	@Base(title) {
		<div id="main-content">
			@content
		</div>
	}
}

// flashDataFromContext converts middleware.FlashData to components.FlashData.
// This helper bridges the middleware and component types for flash messages.
func flashDataFromContext(ctx context.Context) components.FlashData {
	data := middleware.GetFlashData(ctx)
	return components.FlashData{
		Success: data.Success,
		Error:   data.Error,
		Info:    data.Info,
	}
}

// csrfHeader returns the CSRF token as a JSON header for HTMX requests.
// This is used with hx-headers to automatically include the token in all requests.
func csrfHeader(ctx context.Context) string {
	token := middleware.GetCSRFToken(ctx)
	return `{"X-CSRF-Token": "` + token + `"}`
}
