package main

import (
	"context"
	"flag"
	"log"

	"[[.ModulePath]]/internal/config"
	"[[.ModulePath]]/internal/database"
[[- if .WithAuth]]
	"[[.ModulePath]]/internal/models"
[[- end]]
)

func main() {
	// Parse flags
	clear := flag.Bool("clear", false, "Clear existing data before seeding")
	flag.Parse()

	// Load configuration
	cfg := config.Load()

	// Initialize database
	db := database.Connect(cfg)

	// Run database migrations
	if err := database.RunMigrations(db); err != nil {
		log.Fatalf("Failed to migrate database: %v", err)
	}

	ctx := context.Background()

	// Clear data if requested
	if *clear {
		log.Println("Clearing existing data...")
		// Add clear operations here
	}

	log.Println("Seeding database...")

[[- if .WithAuth]]

	// Seed roles
	log.Println("Seeding roles...")
	if err := models.SeedRoles(db); err != nil {
		log.Printf("Warning: failed to seed roles: %v", err)
	}

	// Seed admin user
	log.Println("Seeding admin user...")
	var existingAdmin models.User
	if err := db.Where("email = ?", "admin@example.com").First(&existingAdmin).Error; err != nil {
		// Admin doesn't exist, create one
		adminRole, err := models.GetRoleByName(db, "admin")
		if err != nil {
			log.Printf("Warning: admin role not found, skipping admin user creation: %v", err)
		} else {
			admin := models.User{
				Email:  "admin@example.com",
				Name:   "Admin User",
				RoleID: adminRole.ID,
				Active: true,
			}
			if err := admin.SetPassword("admin123"); err != nil {
				log.Printf("Warning: failed to set admin password: %v", err)
			} else {
				if err := db.Create(&admin).Error; err != nil {
					log.Printf("Warning: failed to create admin user: %v", err)
				} else {
					log.Println("Admin user created: admin@example.com / admin123")
				}
			}
		}
	} else {
		log.Println("Admin user already exists, skipping...")
	}
[[- end]]

	// Run custom seeders
	// Add seeder calls here
	_ = db
	_ = ctx

	log.Println("Seeding completed successfully!")
}
