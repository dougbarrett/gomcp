package web

import (
	"context"
	"encoding/json"
	"net/http"

	"github.com/a-h/templ"
)

// Response provides helper methods for HTTP responses.
type Response struct {
	w http.ResponseWriter
	r *http.Request
}

// NewResponse creates a new response helper.
func NewResponse(w http.ResponseWriter, r *http.Request) *Response {
	return &Response{w: w, r: r}
}

// JSON writes a JSON response.
func (res *Response) JSON(status int, data interface{}) error {
	res.w.Header().Set("Content-Type", "application/json")
	res.w.WriteHeader(status)
	return json.NewEncoder(res.w).Encode(data)
}

// HTML writes an HTML response using a templ component.
func (res *Response) HTML(status int, component templ.Component) error {
	res.w.Header().Set("Content-Type", "text/html; charset=utf-8")
	res.w.WriteHeader(status)
	return component.Render(context.Background(), res.w)
}

// Render renders a templ component with the request context.
func (res *Response) Render(component templ.Component) error {
	res.w.Header().Set("Content-Type", "text/html; charset=utf-8")
	return component.Render(res.r.Context(), res.w)
}

// Error writes an error response.
func (res *Response) Error(status int, message string) {
	if res.IsHTMX() {
		res.w.Header().Set("Content-Type", "text/html; charset=utf-8")
		res.w.WriteHeader(status)
		res.w.Write([]byte(`<div class="text-red-500">` + message + `</div>`))
		return
	}
	http.Error(res.w, message, status)
}

// Redirect performs an HTTP redirect or HTMX redirect.
func (res *Response) Redirect(url string) {
	if res.IsHTMX() {
		res.w.Header().Set("HX-Redirect", url)
		res.w.WriteHeader(http.StatusOK)
		return
	}
	http.Redirect(res.w, res.r, url, http.StatusFound)
}

// IsHTMX returns true if this is an HTMX request.
func (res *Response) IsHTMX() bool {
	return res.r.Header.Get("HX-Request") == "true"
}

// HTMXTrigger triggers a custom HTMX event.
func (res *Response) HTMXTrigger(event string) {
	res.w.Header().Set("HX-Trigger", event)
}

// HTMXReswap changes the swap behavior.
func (res *Response) HTMXReswap(swap string) {
	res.w.Header().Set("HX-Reswap", swap)
}

// HTMXRetarget changes the target element.
func (res *Response) HTMXRetarget(target string) {
	res.w.Header().Set("HX-Retarget", target)
}

// HTMXPushURL updates the browser URL.
func (res *Response) HTMXPushURL(url string) {
	res.w.Header().Set("HX-Push-Url", url)
}

// Success sends a success toast notification via HTMX trigger.
// Note: This only works for HTMX requests. For non-HTMX requests that need
// flash messages across redirects, use SessionManager.AddFlashSuccess() instead.
// Example with auth:
//
//	if res.IsHTMX() {
//	    res.Success("Item created")
//	} else {
//	    sessionManager.AddFlashSuccess(w, r, "Item created")
//	}
func (res *Response) Success(message string) {
	res.w.Header().Set("HX-Trigger", `{"showToast": {"message": "`+message+`", "type": "success"}}`)
}

// ErrorToast sends an error toast notification via HTMX trigger.
// Note: This only works for HTMX requests. For non-HTMX requests that need
// flash messages across redirects, use SessionManager.AddFlashError() instead.
func (res *Response) ErrorToast(message string) {
	res.w.Header().Set("HX-Trigger", `{"showToast": {"message": "`+message+`", "type": "error"}}`)
}

// LayoutFunc is a function that wraps content in a layout.
// Layout templates like Dashboard(title) return a templ.Component that accepts children.
// This type represents that pattern for use with WithLayout.
type LayoutFunc func(content templ.Component) templ.Component

// WithLayout composes a layout with content, returning a renderable component.
// This enables easy layout composition from Go controller code.
//
// Example usage:
//
//	// Define a layout wrapper
//	dashboardLayout := func(content templ.Component) templ.Component {
//	    return layouts.DashboardPage("Users", content)
//	}
//
//	// Render with layout
//	res.Render(web.WithLayout(dashboardLayout, views.UserList(props)))
//
// For simpler cases, use RenderWithLayout directly.
func WithLayout(layout LayoutFunc, content templ.Component) templ.Component {
	return layout(content)
}

// RenderWithLayout renders content wrapped in a layout function.
// This is a convenience method combining WithLayout and Render.
//
// Example:
//
//	res.RenderWithLayout(
//	    func(c templ.Component) templ.Component {
//	        return layouts.DashboardPage("Users", c)
//	    },
//	    views.UserList(props),
//	)
func (res *Response) RenderWithLayout(layout LayoutFunc, content templ.Component) error {
	return res.Render(WithLayout(layout, content))
}
