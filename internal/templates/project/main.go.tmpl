package main

import (
	"log"
	"net/http"

	"[[.ModulePath]]/internal/config"
	"[[.ModulePath]]/internal/database"
	"[[.ModulePath]]/internal/models"
	"[[.ModulePath]]/internal/web"
[[- if .WithAuth]]
	"github.com/go-chi/chi/v5"
	userrepo "[[.ModulePath]]/internal/repository/user"
	"[[.ModulePath]]/internal/services/auth"
	authweb "[[.ModulePath]]/internal/web/auth"
	"[[.ModulePath]]/internal/web/dashboard"
	"[[.ModulePath]]/internal/web/middleware"
	"[[.ModulePath]]/internal/web/profile"
[[- end]]
	// MCP:IMPORTS:START
	// MCP:IMPORTS:END
)

func main() {
	// Load configuration
	cfg := config.Load()

	// Initialize database
	db := database.Connect(cfg)

	// Auto-migrate database models
	if err := db.AutoMigrate(
		// MCP:MODELS:START
[[- if .WithAuth]]
		&models.Role{},
		&models.User{},
[[- end]]
		// MCP:MODELS:END
	); err != nil {
		log.Fatalf("Failed to migrate database: %v", err)
	}

[[- if .WithAuth]]
	// Seed default roles
	models.SeedRoles(db)
[[- end]]

	// Wire dependencies: Repos -> Services -> Controllers
	// MCP:REPOS:START
[[- if .WithAuth]]
	userRepo := userrepo.NewRepository(db)
[[- end]]
	// MCP:REPOS:END

	// MCP:SERVICES:START
[[- if .WithAuth]]
	authService := auth.NewService(userRepo, cfg)
[[- end]]
	// MCP:SERVICES:END

	// MCP:CONTROLLERS:START
[[- if .WithAuth]]
	authController := authweb.NewController(authService)
	dashboardController := dashboard.NewController()
	profileController := profile.NewController(authService)
	authMiddleware := middleware.NewAuthMiddleware(authService)
[[- end]]
	// MCP:CONTROLLERS:END

	// Setup router
	router := web.NewRouter(cfg)

[[- if .WithAuth]]
	// Apply flash middleware to read session flash messages
	router.Use(authMiddleware.FlashMiddleware)
[[- end]]

	// Register routes
	// MCP:ROUTES:START
[[- if .WithAuth]]
	// Auth routes (login, register, logout)
	router.Route("/", authController.RegisterRoutes)

	// Protected routes
	router.Group(func(r chi.Router) {
		r.Use(authMiddleware.RequireAuth)
		r.Route("/dashboard", dashboardController.RegisterRoutes)
		r.Route("/profile", profileController.RegisterRoutes)
		r.Route("/settings", profileController.RegisterRoutes) // Settings alias for profile
	})
[[- end]]
	// MCP:ROUTES:END

	log.Printf("Server starting on %s", cfg.Server.Address)
	log.Fatal(http.ListenAndServe(cfg.Server.Address, router))
}
