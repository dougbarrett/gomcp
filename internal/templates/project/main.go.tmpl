package main

import (
	"log"
	"net/http"

	"[[.ModulePath]]/internal/config"
	"[[.ModulePath]]/internal/database"
	"[[.ModulePath]]/internal/models"
	"[[.ModulePath]]/internal/web"
[[- if .WithAuth]]
	"github.com/go-chi/chi/v5"
	userrepo "[[.ModulePath]]/internal/repository/user"
	"[[.ModulePath]]/internal/services/auth"
[[- if .WithUserManagement]]
	usersvc "[[.ModulePath]]/internal/services/user"
[[- end]]
	authweb "[[.ModulePath]]/internal/web/auth"
	"[[.ModulePath]]/internal/web/dashboard"
	"[[.ModulePath]]/internal/web/middleware"
	"[[.ModulePath]]/internal/web/profile"
[[- if .WithUserManagement]]
	"[[.ModulePath]]/internal/web/users"
[[- end]]
[[- end]]
	// MCP:IMPORTS:START
	// MCP:IMPORTS:END
)

func main() {
	// Load configuration
	cfg := config.Load()

	// Initialize database
	db := database.Connect(cfg)

	// Auto-migrate database models
	if err := db.AutoMigrate(
		// MCP:MODELS:START
[[- if .WithAuth]]
		&models.Role{},
		&models.User{},
[[- end]]
		// MCP:MODELS:END
	); err != nil {
		log.Fatalf("Failed to migrate database: %v", err)
	}

[[- if .WithAuth]]
	// Seed default roles
	models.SeedRoles(db)
[[- end]]

	// Wire dependencies: Repos -> Services -> Controllers
	// MCP:REPOS:START
[[- if .WithAuth]]
	userRepo := userrepo.NewRepository(db)
[[- end]]
	// MCP:REPOS:END

	// MCP:SERVICES:START
[[- if .WithAuth]]
	authService := auth.NewService(userRepo, cfg)
[[- if .WithUserManagement]]
	userService := usersvc.NewService(userRepo)
[[- end]]
[[- end]]
	// MCP:SERVICES:END

	// MCP:CONTROLLERS:START
[[- if .WithAuth]]
	authController := authweb.NewController(authService)
	dashboardController := dashboard.NewController()
	profileController := profile.NewController(authService)
	authMiddleware := middleware.NewAuthMiddleware(authService)
[[- if .WithUserManagement]]
	usersController := users.NewController(userService, authService)
[[- end]]
[[- end]]
	// MCP:CONTROLLERS:END

	// Setup router (middleware only - no routes yet)
	router := web.NewRouter(cfg)

[[- if .WithAuth]]
	// Apply flash middleware to read session flash messages
	// This MUST come before any routes are registered (chi requirement)
	router.Use(authMiddleware.FlashMiddleware)
[[- end]]

	// Register static routes (assets, health check)
	// This comes after all middleware is applied
	web.RegisterStaticRoutes(router)

	// Register routes
	// MCP:ROUTES:START
[[- if .WithAuth]]
	// Auth routes (login, logout) - use RegisterLoginRoutes for login-only
	// Change to authController.RegisterRoutes to also enable public registration
	router.Route("/", authController.RegisterLoginRoutes)

	// Home page redirects to dashboard (which redirects to login if not authenticated)
	router.Get("/", func(w http.ResponseWriter, r *http.Request) {
		http.Redirect(w, r, "/dashboard", http.StatusSeeOther)
	})

	// Protected routes
	router.Group(func(r chi.Router) {
		r.Use(authMiddleware.RequireAuth)
		r.Route("/dashboard", dashboardController.RegisterRoutes)
		r.Route("/profile", profileController.RegisterRoutes)
		r.Route("/settings", profileController.RegisterRoutes) // Settings alias for profile
	})
[[- if .WithUserManagement]]

	// Admin routes (require admin role)
	router.Group(func(r chi.Router) {
		r.Use(authMiddleware.RequireAuth)
		r.Use(authMiddleware.RequireAdmin)
		r.Route("/admin/users", usersController.RegisterRoutes)
	})
[[- end]]
[[- else]]
	// Home page
	web.RegisterHomeRoute(router)
[[- end]]
	// MCP:ROUTES:END

	log.Printf("Server starting on %s", cfg.Server.Address)
	log.Fatal(http.ListenAndServe(cfg.Server.Address, router))
}
