---
phase: 09-wizard-bug-fixes
plan: 03
type: execute
---

<objective>
Fix belongs_to display field handling in dto.go.tmpl to respect the display_field option.

Purpose: Allow related models to be displayed by custom fields (Title, Email, etc.) instead of hardcoded Name.
Output: Generated DTOs use the specified display_field for relationship summaries.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-wizard-bug-fixes/09-02-SUMMARY.md

**Bug to fix:**
- **69d42b6e**: belongs_to display assumes related model has Name field

**Key files:**
@internal/templates/domain/dto.go.tmpl
@internal/generator/data.go (lines 704-789 for DisplayField handling)
@internal/templates/templates_test.go (TestBelongsToDisplayFieldRendering - existing test)

**Context from existing code:**
- Relationships have DisplayField property that defaults to "Name"
- Form and show templates already use [[.DisplayField]] correctly
- dto.go.tmpl line 78 has hardcoded `Name string` in Summary struct
- Mapping code in To...Response doesn't populate the display field value
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Summary struct to use DisplayField</name>
  <files>internal/templates/domain/dto.go.tmpl</files>
  <action>
  In dto.go.tmpl around line 75-79, the Summary struct is defined as:
  ```go
  type [[.Model]]Summary struct {
      ID   uint   `json:"id"`
      Name string `json:"name,omitempty"`
  }
  ```

  Change the hardcoded `Name` to use the relationship's DisplayField:
  ```go
  type [[.Model]]Summary struct {
      ID   uint   `json:"id"`
      [[.DisplayField]] string `json:"[[.DisplayField | toLower]],omitempty"`
  }
  ```

  This ensures the Summary struct field matches the actual display field of the related model (e.g., Title for categories, Email for users).
  </action>
  <verify>grep "DisplayField" internal/templates/domain/dto.go.tmpl shows the updated template</verify>
  <done>Summary struct uses [[.DisplayField]] instead of hardcoded Name</done>
</task>

<task type="auto">
  <name>Task 2: Update To...Response to populate display field</name>
  <files>internal/templates/domain/dto.go.tmpl</files>
  <action>
  In the To...Response function around lines 103-107, the relationship mapping only sets ID:
  ```go
  resp.[[.FieldName]] = &[[.Model]]Summary{
      ID: [[$.VariableName]].[[.FieldName]].ID,
  }
  ```

  Update to also populate the display field:
  ```go
  resp.[[.FieldName]] = &[[.Model]]Summary{
      ID: [[$.VariableName]].[[.FieldName]].ID,
      [[.DisplayField]]: [[$.VariableName]].[[.FieldName]].[[.DisplayField]],
  }
  ```

  Apply the same change to all relationship types (BelongsTo, HasOne, HasMany, ManyToMany) in the mapping section.
  </action>
  <verify>grep -A3 "Summary{" internal/templates/domain/dto.go.tmpl shows DisplayField is populated</verify>
  <done>All Summary mappings populate both ID and DisplayField</done>
</task>

<task type="auto">
  <name>Task 3: Verify existing test passes with fixes</name>
  <files>internal/templates/templates_test.go</files>
  <action>
  The existing TestBelongsToDisplayFieldRendering test (around line 1286) should now pass with the template fixes.

  Run the test to verify:
  1. Form template uses opt.[[DisplayField]] (already passing per test code)
  2. Show template uses props.Item.[[Model]].[[DisplayField]] (already passing per test code)
  3. Add assertions for dto.go.tmpl:
     - Summary struct field name is DisplayField (e.g., Title not Name)
     - To...Response mapping populates the DisplayField value

  If the test doesn't cover dto.go.tmpl, add test cases for it following the existing pattern.
  </action>
  <verify>go test ./internal/templates/... -run TestBelongsToDisplayField -v passes</verify>
  <done>Tests verify all templates correctly use DisplayField for belongs_to relationships</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build -o /tmp/gomcp ./cmd/gomcp` succeeds
- [ ] `go test ./internal/templates/...` passes all tests
- [ ] Generated dto.go uses correct display field for Summary structs
- [ ] Example: if display_field is "Title", Summary has Title field not Name
</verification>

<success_criteria>

- dto.go.tmpl uses [[.DisplayField]] in Summary struct definition
- To...Response mapping populates the display field value
- Tests verify the behavior
</success_criteria>

<output>
After completion, create `.planning/phases/09-wizard-bug-fixes/09-03-SUMMARY.md`
</output>
