---
phase: 02-controller-template-fixes
plan: 02
type: execute
subsystem: templates
---

<objective>
Fix all response method calls and URL construction in wizard controller template.

Purpose: Fix CTRL-001, CTRL-002, CTRL-003, CTRL-008 issues - complete Bug #a9479784 resolution
Output: Updated controller.go.tmpl with correct method calls matching domain controller pattern
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work in this phase:
@.planning/phases/02-controller-template-fixes/02-01-SUMMARY.md

# Prior analysis:
@.planning/phases/01-analysis/ANALYSIS-FINDINGS.md

# Reference templates (correct patterns):
@internal/templates/domain/controller.go.tmpl

# File to fix:
@internal/templates/wizard/controller.go.tmpl

**Tech stack:** Go templates with [[ ]] delimiters, web.Response helper, templ components
**Established patterns:** Domain controller uses resp.Redirect(), c.render(), middleware.GetCSRFToken()
**Constraining decisions:** None

**Issues being addressed:**
- CTRL-001: HXRedirect -> Redirect (lines 63, 66, 89, 136, 181, 183, 188, 190, 248)
- CTRL-002: Component -> c.render() (line 136 and others)
- CTRL-003: CSRFToken -> middleware.GetCSRFToken(r.Context()) (line 115)
- CTRL-008: URL double slashes in redirects
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix response method calls</name>
  <files>internal/templates/wizard/controller.go.tmpl</files>
  <action>
Fix all three categories of broken method calls:

**1. HXRedirect -> Redirect (CTRL-001)**
Find all occurrences of `resp.HXRedirect(...)` and replace with `resp.Redirect(...)`.
Lines to check: 63, 66, 89, 136, 181, 183, 188, 190, 248

**2. Component -> c.render (CTRL-002)**
Find all occurrences of `resp.Component(...)` and replace with `c.render(w, r, ...)`.
The render method was added in Plan 02-01, so this will now work.

Example transformation:
- Before: `resp.Component(views.[[$.WizardNamePascal]]Step[[add $i 1]](props))`
- After: `c.render(w, r, views.[[$.WizardNamePascal]]Step[[add $i 1]](props))`

**3. CSRFToken -> middleware.GetCSRFToken (CTRL-003)**
Find all occurrences of `resp.CSRFToken()` and replace with `middleware.GetCSRFToken(r.Context())`.
Line 115 and any other occurrences.

The middleware import was added in Plan 02-01.
  </action>
  <verify>
Run: `grep -n "HXRedirect\|resp\.Component\|resp\.CSRFToken" internal/templates/wizard/controller.go.tmpl`
Should return no matches (all replaced)
  </verify>
  <done>
- No occurrences of resp.HXRedirect() remain
- No occurrences of resp.Component() remain
- No occurrences of resp.CSRFToken() remain
- All replaced with correct method calls
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix URL double slash construction</name>
  <files>internal/templates/wizard/controller.go.tmpl</files>
  <action>
Fix URL construction to prevent double slashes.

Current pattern: `fmt.Sprintf("[[.URLPath]]/wizard/...")`
Problem: If URLPath is "/orders", result is "/orders/wizard/..." (correct)
         If URLPath is "/orders/", result is "/orders//wizard/..." (broken)

Two options (choose simpler approach):

**Option A: Ensure URLPath never has trailing slash**
Check scaffold_wizard.go to confirm URLPath is normalized without trailing slash.
If so, no template changes needed - document this invariant.

**Option B: Add path normalization in template**
Use `[[.URLPath | trimSuffix "/"]]` or wrap in a path.Join equivalent.

First check the generator to see if URLPath is normalized. If it is, document the invariant.
If not, fix the template to handle it.

Lines to check: 63, 66, 89, 181, 183, 188, 190, 248
  </action>
  <verify>
Run: `grep -n "URLPath.*wizard" internal/templates/wizard/controller.go.tmpl`
Review the output to confirm URL construction is safe
  </verify>
  <done>
- URL construction verified safe (either URLPath guaranteed clean, or template handles it)
- No possibility of double slashes in generated URLs
- Decision documented in summary
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No broken method calls remain in template
- [ ] URL construction is safe
- [ ] Build test: `go build -o /tmp/gomcp ./cmd/mcp`
- [ ] Generate test wizard and verify output compiles (optional but recommended)
</verification>

<success_criteria>
- Bug #a9479784 fully resolved (all 8 CTRL issues fixed)
- Template generates correct Go code
- No compilation errors in generated wizard code
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-controller-template-fixes/02-02-SUMMARY.md`

Include in summary:
- Confirmation that Bug #a9479784 is resolved
- List of all method call transformations made
- Decision on URL handling approach
</output>
