---
phase: 05-draft-system-review
plan: 02
type: execute
---

<objective>
Fix URL routing issues in draft save/resume workflow for correct wizard navigation.

Purpose: Ensure draft-enabled wizards correctly navigate between steps with persistent draft state.
Output: Fixed controller.go.tmpl with consistent draft ID handling via query parameters.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-draft-system-review/05-01-SUMMARY.md

# File to fix:
@internal/templates/wizard/controller.go.tmpl

**Issue Being Fixed:**
URL routing mismatch in draft workflow:

1. Routes registered:
   - `/wizard/{name}/new` - Start
   - `/wizard/{name}/{draftID}` - Resume
   - `/wizard/{name}/step/N` - Step handlers
   - `/wizard/{name}/submit` - Submit

2. Current redirects (BROKEN):
   - Start (line 75): `{URLPath}/wizard/{name}/{draftID}/step/1` - No route exists!
   - Resume (line 101): `{URLPath}/wizard/{name}/{draftID}/step/{step}` - No route exists!

3. Expected pattern (working in step handlers):
   - `{URLPath}/wizard/{name}/step/N?draft_id=X`

The step handlers already correctly read draft_id from query params (line 114-121).
The fix is to make Start/Resume redirects match the existing query param pattern.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Start redirect URL</name>
  <files>internal/templates/wizard/controller.go.tmpl</files>
  <action>In the Start() function (around line 75), change the redirect from:
```go
resp.Redirect(fmt.Sprintf("[[.URLPath]]/wizard/[[.WizardName]]/%d/step/1", draft.ID))
```

To:
```go
resp.Redirect(fmt.Sprintf("[[.URLPath]]/wizard/[[.WizardName]]/step/1?draft_id=%d", draft.ID))
```

This matches the pattern that step handlers expect (reading draft_id from query params).</action>
  <verify>grep "step/1?draft_id" internal/templates/wizard/controller.go.tmpl returns the fixed line</verify>
  <done>Start() redirects to /step/1?draft_id=X matching step handler expectations</done>
</task>

<task type="auto">
  <name>Task 2: Fix Resume redirect URL</name>
  <files>internal/templates/wizard/controller.go.tmpl</files>
  <action>In the Resume() function (around line 101), change the redirect from:
```go
resp.Redirect(fmt.Sprintf("[[.URLPath]]/wizard/[[.WizardName]]/%d/step/%d", draft.ID, draft.CurrentStep))
```

To:
```go
resp.Redirect(fmt.Sprintf("[[.URLPath]]/wizard/[[.WizardName]]/step/%d?draft_id=%d", draft.CurrentStep, draft.ID))
```

Note the parameter order change - CurrentStep comes first in the path, draft.ID as query param.</action>
  <verify>grep "step/%d?draft_id" internal/templates/wizard/controller.go.tmpl returns the fixed line</verify>
  <done>Resume() redirects to /step/N?draft_id=X matching step handler expectations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Start() redirect uses query param format: `/step/1?draft_id=%d`
- [ ] Resume() redirect uses query param format: `/step/%d?draft_id=%d`
- [ ] No references to `/%d/step/` pattern remain (the broken path format)
- [ ] Step handlers continue to read draft_id from query params (unchanged)
</verification>

<success_criteria>
- All draft redirects use consistent query parameter pattern
- URL structure matches registered routes
- Draft workflow navigates correctly: Start -> Step 1 -> ... -> Submit
</success_criteria>

<output>
After completion, create `.planning/phases/05-draft-system-review/05-02-SUMMARY.md`
</output>
